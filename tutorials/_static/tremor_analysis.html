<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tremor analysis &mdash; paradigma  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=a31c8b26" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=a31c8b26" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Pulse rate analysis" href="pulse_rate_analysis.html" />
    <link rel="prev" title="Gait analysis" href="gait_analysis.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            paradigma
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data_preparation.html">Data preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="gait_analysis.html">Gait analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="gait_analysis.html#head">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tremor analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#load-example-data">Load example data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-1-preprocess-data">Step 1: Preprocess data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-2-extract-tremor-features">Step 2: Extract tremor features</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-3-detect-tremor">Step 3: Detect tremor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#store-as-tsdf">Store as TSDF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#step-4-quantify-tremor">Step 4: Quantify tremor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#run-steps-1-4-for-all-segments">Run steps 1 - 4 for all segments <a id='multiple_segments_cell'></a></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#step-5-compute-aggregated-tremor-measures">Step 5: Compute aggregated tremor measures</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pulse_rate_analysis.html">Pulse rate analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guides/config.html">Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/coordinate_system.html">Coordinate System</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">paradigma</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tremor analysis</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/_static/tremor_analysis.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tremor-analysis">
<h1>Tremor analysis<a class="headerlink" href="#tremor-analysis" title="Link to this heading"></a></h1>
<p>This tutorial shows how to run the tremor pipeline to obtain aggregated tremor measures from gyroscope sensor data. Before following along, make sure all data preparation steps have been followed in the data preparation tutorial.</p>
<p>In this tutorial, we use two days of data from a participant of the Personalized Parkinson Project to demonstrate the functionalities. Since <code class="docutils literal notranslate"><span class="pre">ParaDigMa</span></code> expects contiguous time series, the collected data was stored in two segments each with contiguous timestamps. Per segment, we load the data and perform the following steps:</p>
<ol class="arabic simple">
<li><p>Preprocess the time series data</p></li>
<li><p>Extract tremor features</p></li>
<li><p>Detect tremor</p></li>
<li><p>Quantify tremor</p></li>
</ol>
<p>We then combine the output of the different segments for the final step:</p>
<ol class="arabic simple" start="5">
<li><p>Compute aggregated tremor measures</p></li>
</ol>
<section id="load-example-data">
<h2>Load example data<a class="headerlink" href="#load-example-data" title="Link to this heading"></a></h2>
<p>Here, we start by loading a single contiguous time series (segment), for which we continue running steps 1-3. Below we show how to run these steps for multiple segments.</p>
<p>We use the interally developed <code class="docutils literal notranslate"><span class="pre">TSDF</span></code> (<a class="reference external" href="https://biomarkersparkinson.github.io/tsdf/">documentation</a>) to load and store data [<a class="reference external" href="https://arxiv.org/abs/2211.11294">1</a>]. Depending on the file extension of your time series data, examples of other Python functions for loading the data into memory include:</p>
<ul class="simple">
<li><p><em>.csv</em>: <code class="docutils literal notranslate"><span class="pre">pandas.read_csv()</span></code> (<a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_csv.html">documentation</a>)</p></li>
<li><p><em>.json</em>: <code class="docutils literal notranslate"><span class="pre">json.load()</span></code> (<a class="reference external" href="https://docs.python.org/3/library/json.html#json.load">documentation</a>)</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tsdf_dataframe</span>

<span class="c1"># Set the path to where the prepared data is saved and load the data.</span>
<span class="c1"># Note: the test data is stored in TSDF, but you can load your data in your own way</span>
<span class="n">path_to_data</span> <span class="o">=</span>  <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../example_data&#39;</span><span class="p">)</span>
<span class="n">path_to_prepared_data</span> <span class="o">=</span> <span class="n">path_to_data</span> <span class="o">/</span> <span class="s1">&#39;imu&#39;</span>

<span class="n">segment_nr</span>  <span class="o">=</span> <span class="s1">&#39;0001&#39;</span>

<span class="n">df_data</span><span class="p">,</span> <span class="n">metadata_time</span><span class="p">,</span> <span class="n">metadata_values</span> <span class="o">=</span> <span class="n">load_tsdf_dataframe</span><span class="p">(</span><span class="n">path_to_prepared_data</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;IMU_segment</span><span class="si">{</span><span class="n">segment_nr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">df_data</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>accelerometer_x</th>
      <th>accelerometer_y</th>
      <th>accelerometer_z</th>
      <th>gyroscope_x</th>
      <th>gyroscope_y</th>
      <th>gyroscope_z</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000000</td>
      <td>-0.474641</td>
      <td>-0.379426</td>
      <td>0.770335</td>
      <td>0.000000</td>
      <td>1.402439</td>
      <td>0.243902</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.009933</td>
      <td>-0.472727</td>
      <td>-0.378947</td>
      <td>0.765072</td>
      <td>0.426829</td>
      <td>0.670732</td>
      <td>-0.121951</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.019867</td>
      <td>-0.471770</td>
      <td>-0.375598</td>
      <td>0.766986</td>
      <td>1.158537</td>
      <td>-0.060976</td>
      <td>-0.304878</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.029800</td>
      <td>-0.472727</td>
      <td>-0.375598</td>
      <td>0.770335</td>
      <td>1.158537</td>
      <td>-0.548780</td>
      <td>-0.548780</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.039733</td>
      <td>-0.475120</td>
      <td>-0.379426</td>
      <td>0.772249</td>
      <td>0.670732</td>
      <td>-0.609756</td>
      <td>-0.731707</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3455326</th>
      <td>34339.561333</td>
      <td>-0.257895</td>
      <td>-0.319139</td>
      <td>-0.761244</td>
      <td>159.329269</td>
      <td>14.634146</td>
      <td>-28.658537</td>
    </tr>
    <tr>
      <th>3455327</th>
      <td>34339.571267</td>
      <td>-0.555502</td>
      <td>-0.153110</td>
      <td>-0.671292</td>
      <td>125.060976</td>
      <td>-213.902440</td>
      <td>-19.329268</td>
    </tr>
    <tr>
      <th>3455328</th>
      <td>34339.581200</td>
      <td>-0.286124</td>
      <td>-0.263636</td>
      <td>-0.981340</td>
      <td>158.658537</td>
      <td>-328.170733</td>
      <td>-3.170732</td>
    </tr>
    <tr>
      <th>3455329</th>
      <td>34339.591133</td>
      <td>-0.232536</td>
      <td>-0.161722</td>
      <td>-0.832536</td>
      <td>288.841465</td>
      <td>-281.707318</td>
      <td>17.073171</td>
    </tr>
    <tr>
      <th>3455330</th>
      <td>34339.601067</td>
      <td>0.180383</td>
      <td>-0.368421</td>
      <td>-1.525837</td>
      <td>376.219514</td>
      <td>-140.853659</td>
      <td>37.256098</td>
    </tr>
  </tbody>
</table>
<p>3455331 rows × 7 columns</p>
</div>
</section>
<section id="step-1-preprocess-data">
<h2>Step 1: Preprocess data<a class="headerlink" href="#step-1-preprocess-data" title="Link to this heading"></a></h2>
<p>IMU sensors collect data at a fixed sampling frequency, but the sampling rate is not uniform, causing variation in time differences between timestamps. The <a class="reference external" href="https://github.com/biomarkersParkinson/paradigma/blob/main/src/paradigma/preprocessing.py#:~:text=preprocess_imu_data">preprocess_imu_data</a> function therefore resamples the timestamps to be uniformly distributed, and then interpolates IMU values at these new timestamps using the original timestamps and corresponding IMU values. If the difference between timestamps is larger than a specified tolerance (<code class="docutils literal notranslate"><span class="pre">config.tolerance</span></code>, in seconds), it will return an error that the timestamps are not contiguous.  If you still want to process the data in this case, you can create segments from discontiguous samples using the function <a class="reference external" href="https://github.com/biomarkersParkinson/paradigma/blob/main/src/paradigma/segmenting.py"><code class="docutils literal notranslate"><span class="pre">create_segments</span></code></a> and analyze these segments consecutively as shown in here. By setting <code class="docutils literal notranslate"><span class="pre">sensor</span></code> to ‘gyroscope’, only gyroscope data is preprocessed and the accelerometer data is removed from the dataframe. Also a <code class="docutils literal notranslate"><span class="pre">watch_side</span></code> should be provided, although for the tremor analysis it does not matter whether this is the correct side since the tremor features are not influenced by the gyroscope axes orientation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">IMUConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataColumns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">preprocess_imu_data</span>

<span class="c1"># Set column names: replace DataColumn.* with your actual column names.</span>
<span class="c1"># It is only necessary to set the columns that are present in your data, and</span>
<span class="c1"># only if they differ from the default names defined in DataColumns.</span>
<span class="n">column_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;TIME&#39;</span><span class="p">:</span> <span class="n">DataColumns</span><span class="o">.</span><span class="n">TIME</span><span class="p">,</span>
    <span class="s1">&#39;ACCELEROMETER_X&#39;</span><span class="p">:</span> <span class="n">DataColumns</span><span class="o">.</span><span class="n">ACCELEROMETER_X</span><span class="p">,</span>
    <span class="s1">&#39;ACCELEROMETER_Y&#39;</span><span class="p">:</span> <span class="n">DataColumns</span><span class="o">.</span><span class="n">ACCELEROMETER_Y</span><span class="p">,</span>
    <span class="s1">&#39;ACCELEROMETER_Z&#39;</span><span class="p">:</span> <span class="n">DataColumns</span><span class="o">.</span><span class="n">ACCELEROMETER_Z</span><span class="p">,</span>
    <span class="s1">&#39;GYROSCOPE_X&#39;</span><span class="p">:</span> <span class="n">DataColumns</span><span class="o">.</span><span class="n">GYROSCOPE_X</span><span class="p">,</span>
    <span class="s1">&#39;GYROSCOPE_Y&#39;</span><span class="p">:</span> <span class="n">DataColumns</span><span class="o">.</span><span class="n">GYROSCOPE_Y</span><span class="p">,</span>
    <span class="s1">&#39;GYROSCOPE_Z&#39;</span><span class="p">:</span> <span class="n">DataColumns</span><span class="o">.</span><span class="n">GYROSCOPE_Z</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">IMUConfig</span><span class="p">(</span><span class="n">column_mapping</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The data is resampled to </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">resampling_frequency</span><span class="si">}</span><span class="s1"> Hz.&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The tolerance for checking contiguous timestamps is set to </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">tolerance</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> seconds.&#39;</span><span class="p">)</span>

<span class="n">df_preprocessed_data</span> <span class="o">=</span> <span class="n">preprocess_imu_data</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;gyroscope&#39;</span><span class="p">,</span> <span class="n">watch_side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

<span class="n">df_preprocessed_data</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The data is resampled to 100 Hz.
The tolerance for checking contiguous timestamps is set to 0.030 seconds.
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>gyroscope_x</th>
      <th>gyroscope_y</th>
      <th>gyroscope_z</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.00</td>
      <td>0.000000</td>
      <td>1.402439</td>
      <td>0.243902</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.01</td>
      <td>0.432231</td>
      <td>0.665526</td>
      <td>-0.123434</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.02</td>
      <td>1.164277</td>
      <td>-0.069584</td>
      <td>-0.307536</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.03</td>
      <td>1.151432</td>
      <td>-0.554928</td>
      <td>-0.554223</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.04</td>
      <td>0.657189</td>
      <td>-0.603207</td>
      <td>-0.731570</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3433956</th>
      <td>34339.56</td>
      <td>130.392434</td>
      <td>29.491627</td>
      <td>-26.868202</td>
    </tr>
    <tr>
      <th>3433957</th>
      <td>34339.57</td>
      <td>135.771133</td>
      <td>-184.515525</td>
      <td>-21.544211</td>
    </tr>
    <tr>
      <th>3433958</th>
      <td>34339.58</td>
      <td>146.364103</td>
      <td>-324.248909</td>
      <td>-5.248641</td>
    </tr>
    <tr>
      <th>3433959</th>
      <td>34339.59</td>
      <td>273.675024</td>
      <td>-293.011330</td>
      <td>14.618256</td>
    </tr>
    <tr>
      <th>3433960</th>
      <td>34339.60</td>
      <td>372.878731</td>
      <td>-158.516265</td>
      <td>35.330770</td>
    </tr>
  </tbody>
</table>
<p>3433961 rows × 4 columns</p>
</div>
</section>
<section id="step-2-extract-tremor-features">
<h2>Step 2: Extract tremor features<a class="headerlink" href="#step-2-extract-tremor-features" title="Link to this heading"></a></h2>
<p>The function <a class="reference external" href="https://github.com/biomarkersParkinson/paradigma/blob/main/src/paradigma/pipelines/tremor_pipeline.py#:~:text=extract_tremor_features"><code class="docutils literal notranslate"><span class="pre">extract_tremor_features</span></code></a> extracts windows from the preprocessed gyroscope data using non-overlapping windows of length <code class="docutils literal notranslate"><span class="pre">config.window_length_s</span></code>. Next, from these windows the tremor features are extracted: 12 mel-frequency cepstral coefficients (MFCCs), frequency of the peak in the power spectral density, power below tremor (0.5 - 3 Hz), and power around the tremor peak. The latter is not used for tremor detection, but stored for tremor quantification in Step 4.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">TremorConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.pipelines.tremor_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_tremor_features</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">TremorConfig</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="s1">&#39;features&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The window length is </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">window_length_s</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>

<span class="n">df_features</span> <span class="o">=</span> <span class="n">extract_tremor_features</span><span class="p">(</span><span class="n">df_preprocessed_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

<span class="n">df_features</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The window length is 4 seconds
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>mfcc_1</th>
      <th>mfcc_2</th>
      <th>mfcc_3</th>
      <th>mfcc_4</th>
      <th>mfcc_5</th>
      <th>mfcc_6</th>
      <th>mfcc_7</th>
      <th>mfcc_8</th>
      <th>mfcc_9</th>
      <th>mfcc_10</th>
      <th>mfcc_11</th>
      <th>mfcc_12</th>
      <th>freq_peak</th>
      <th>below_tremor_power</th>
      <th>tremor_power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>5.323582</td>
      <td>1.179579</td>
      <td>-0.498552</td>
      <td>-0.149152</td>
      <td>-0.063535</td>
      <td>-0.132090</td>
      <td>-0.112380</td>
      <td>-0.044326</td>
      <td>-0.025917</td>
      <td>0.116045</td>
      <td>0.169869</td>
      <td>0.213884</td>
      <td>3.75</td>
      <td>0.082219</td>
      <td>0.471588</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4.0</td>
      <td>5.333162</td>
      <td>1.205712</td>
      <td>-0.607844</td>
      <td>-0.138371</td>
      <td>-0.039518</td>
      <td>-0.137703</td>
      <td>-0.069552</td>
      <td>-0.008029</td>
      <td>-0.087711</td>
      <td>0.089844</td>
      <td>0.152380</td>
      <td>0.195165</td>
      <td>3.75</td>
      <td>0.071260</td>
      <td>0.327252</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.0</td>
      <td>5.180974</td>
      <td>1.039548</td>
      <td>-0.627100</td>
      <td>-0.054816</td>
      <td>-0.016767</td>
      <td>-0.044817</td>
      <td>0.079859</td>
      <td>-0.023155</td>
      <td>0.024729</td>
      <td>0.104989</td>
      <td>0.126502</td>
      <td>0.192319</td>
      <td>7.75</td>
      <td>0.097961</td>
      <td>0.114138</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12.0</td>
      <td>5.290298</td>
      <td>1.183957</td>
      <td>-0.627651</td>
      <td>-0.027235</td>
      <td>0.095184</td>
      <td>-0.050455</td>
      <td>-0.024654</td>
      <td>0.029754</td>
      <td>-0.007459</td>
      <td>0.125700</td>
      <td>0.146895</td>
      <td>0.220589</td>
      <td>7.75</td>
      <td>0.193237</td>
      <td>0.180988</td>
    </tr>
    <tr>
      <th>4</th>
      <td>16.0</td>
      <td>5.128074</td>
      <td>1.066869</td>
      <td>-0.622282</td>
      <td>0.038557</td>
      <td>-0.034719</td>
      <td>0.045109</td>
      <td>0.076679</td>
      <td>0.057267</td>
      <td>-0.024619</td>
      <td>0.131755</td>
      <td>0.177849</td>
      <td>0.149686</td>
      <td>7.75</td>
      <td>0.156469</td>
      <td>0.090009</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8579</th>
      <td>34316.0</td>
      <td>7.071408</td>
      <td>-0.376556</td>
      <td>0.272322</td>
      <td>0.068750</td>
      <td>0.051588</td>
      <td>0.102012</td>
      <td>0.055017</td>
      <td>0.115942</td>
      <td>0.012746</td>
      <td>0.117970</td>
      <td>0.073279</td>
      <td>0.057367</td>
      <td>13.50</td>
      <td>48.930380</td>
      <td>91.971686</td>
    </tr>
    <tr>
      <th>8580</th>
      <td>34320.0</td>
      <td>1.917642</td>
      <td>0.307927</td>
      <td>0.142330</td>
      <td>0.265357</td>
      <td>0.285635</td>
      <td>0.143886</td>
      <td>0.259636</td>
      <td>0.195724</td>
      <td>0.176947</td>
      <td>0.162205</td>
      <td>0.147897</td>
      <td>0.170488</td>
      <td>11.00</td>
      <td>0.012123</td>
      <td>0.000316</td>
    </tr>
    <tr>
      <th>8581</th>
      <td>34324.0</td>
      <td>2.383806</td>
      <td>0.268580</td>
      <td>0.151254</td>
      <td>0.414430</td>
      <td>0.241540</td>
      <td>0.244071</td>
      <td>0.201109</td>
      <td>0.209611</td>
      <td>0.097146</td>
      <td>0.048798</td>
      <td>0.013239</td>
      <td>0.035379</td>
      <td>2.00</td>
      <td>0.013077</td>
      <td>0.000615</td>
    </tr>
    <tr>
      <th>8582</th>
      <td>34328.0</td>
      <td>1.883626</td>
      <td>0.089983</td>
      <td>0.196880</td>
      <td>0.300523</td>
      <td>0.239185</td>
      <td>0.259342</td>
      <td>0.277586</td>
      <td>0.206517</td>
      <td>0.178499</td>
      <td>0.215561</td>
      <td>0.067234</td>
      <td>0.123958</td>
      <td>13.75</td>
      <td>0.011466</td>
      <td>0.000211</td>
    </tr>
    <tr>
      <th>8583</th>
      <td>34332.0</td>
      <td>2.599103</td>
      <td>0.286252</td>
      <td>-0.014529</td>
      <td>0.475488</td>
      <td>0.229446</td>
      <td>0.188200</td>
      <td>0.173689</td>
      <td>0.033262</td>
      <td>0.138957</td>
      <td>0.106176</td>
      <td>0.036859</td>
      <td>0.082178</td>
      <td>12.50</td>
      <td>0.015068</td>
      <td>0.000891</td>
    </tr>
  </tbody>
</table>
<p>8584 rows × 16 columns</p>
</div>
</section>
<section id="step-3-detect-tremor">
<h2>Step 3: Detect tremor<a class="headerlink" href="#step-3-detect-tremor" title="Link to this heading"></a></h2>
<p>The function <a class="reference external" href="https://github.com/biomarkersParkinson/paradigma/blob/main/src/paradigma/pipelines/tremor_pipeline.py#:~:text=detect_tremor"><code class="docutils literal notranslate"><span class="pre">detect_tremor</span></code></a> uses a pretrained logistic regression classifier to predict the tremor probability (<code class="docutils literal notranslate"><span class="pre">pred_tremor_proba</span></code>) for each window, based on the MFCCs. Using the prespecified threshold, a tremor label of 0 (no tremor) or 1 (tremor) is assigned (<code class="docutils literal notranslate"><span class="pre">pred_tremor_logreg</span></code>). Furthermore, the detected tremor windows are checked for rest tremor in two ways. First, the frequency of the peak should be between 3-7 Hz. Second, we want to exclude windows with significant arm movements. We consider a window to have significant arm movement if <code class="docutils literal notranslate"><span class="pre">below_tremor_power</span></code> exceeds <code class="docutils literal notranslate"><span class="pre">config.movement_threshold</span></code>. The final tremor label is saved in <code class="docutils literal notranslate"><span class="pre">pred_tremor_checked</span></code>. A label for predicted arm at rest (<code class="docutils literal notranslate"><span class="pre">pred_arm_at_rest</span></code>, which is 1 when at rest and 0 when not at rest) was also saved, to control for the amount of arm movement during the observed time period when aggregating the amount of tremor time in Step 4 (if a person is moving their arm, they cannot have rest tremor).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">importlib.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">files</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.pipelines.tremor_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">detect_tremor</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A threshold of </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">movement_threshold</span><span class="si">}</span><span class="s1"> deg</span><span class="se">\u00b2</span><span class="s1">/s</span><span class="se">\u00b2</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">is used to determine whether the arm is at rest or in stable posture.&#39;</span><span class="p">)</span>

<span class="c1"># Load the pre-trained logistic regression classifier</span>
<span class="n">tremor_detection_classifier_package_filename</span> <span class="o">=</span> <span class="s1">&#39;tremor_detection_clf_package.pkl&#39;</span>
<span class="n">full_path_to_classifier_package</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="s1">&#39;paradigma&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;assets&#39;</span> <span class="o">/</span> <span class="n">tremor_detection_classifier_package_filename</span>

<span class="c1"># Use the logistic regression classifier to detect tremor and check for rest tremor</span>
<span class="n">df_predictions</span> <span class="o">=</span> <span class="n">detect_tremor</span><span class="p">(</span><span class="n">df_features</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">full_path_to_classifier_package</span><span class="p">)</span>

<span class="n">df_predictions</span><span class="p">[[</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_proba&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_logreg&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_arm_at_rest&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_checked&#39;</span><span class="p">]]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>A threshold of 50 deg²/s² is used to determine whether the arm is at rest or in stable posture.
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>pred_tremor_proba</th>
      <th>pred_tremor_logreg</th>
      <th>pred_arm_at_rest</th>
      <th>pred_tremor_checked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0.038968</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4.0</td>
      <td>0.035365</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.0</td>
      <td>0.031255</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12.0</td>
      <td>0.021106</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>16.0</td>
      <td>0.021078</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8579</th>
      <td>34316.0</td>
      <td>0.000296</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8580</th>
      <td>34320.0</td>
      <td>0.000089</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8581</th>
      <td>34324.0</td>
      <td>0.000023</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8582</th>
      <td>34328.0</td>
      <td>0.000053</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8583</th>
      <td>34332.0</td>
      <td>0.000049</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>8584 rows × 5 columns</p>
</div>
<section id="store-as-tsdf">
<h3>Store as TSDF<a class="headerlink" href="#store-as-tsdf" title="Link to this heading"></a></h3>
<p>The predicted probabilities (and optionally other features) can be stored and loaded in TSDF as demonstrated below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tsdf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">write_df_data</span>

<span class="c1"># Set &#39;path_to_data&#39; to the directory where you want to save the data</span>
<span class="n">metadata_time_store</span> <span class="o">=</span> <span class="n">tsdf</span><span class="o">.</span><span class="n">TSDFMetadata</span><span class="p">(</span><span class="n">metadata_time</span><span class="o">.</span><span class="n">get_plain_tsdf_dict_copy</span><span class="p">(),</span> <span class="n">path_to_data</span><span class="p">)</span>
<span class="n">metadata_values_store</span> <span class="o">=</span> <span class="n">tsdf</span><span class="o">.</span><span class="n">TSDFMetadata</span><span class="p">(</span><span class="n">metadata_values</span><span class="o">.</span><span class="n">get_plain_tsdf_dict_copy</span><span class="p">(),</span> <span class="n">path_to_data</span><span class="p">)</span>

<span class="o">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
<span class="c1"># Select the columns to be saved</span>
<span class="n">metadata_time_store</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<span class="o">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
<span class="o">=======</span>
<span class="o">=======</span>
<span class="c1"># Select the columns to be saved</span>
<span class="n">metadata_time_store</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="mi">37</span><span class="n">f1c8fea7b90d0e387febafe838f2df6ab9dd47</span>
<span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">origin</span><span class="o">/</span><span class="n">main</span>
<span class="n">metadata_values_store</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tremor_power&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_proba&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_logreg&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_arm_at_rest&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_checked&#39;</span><span class="p">]</span>

<span class="c1"># Set the units</span>
<span class="n">metadata_time_store</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Relative seconds&#39;</span><span class="p">]</span>
<span class="o">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
<span class="n">metadata_values_store</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">]</span>
<span class="o">=======</span>
<span class="o">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
<span class="n">metadata_values_store</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">]</span>
<span class="o">=======</span>
<span class="n">metadata_values_store</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;Unitless&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="mi">37</span><span class="n">f1c8fea7b90d0e387febafe838f2df6ab9dd47</span>
<span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">origin</span><span class="o">/</span><span class="n">main</span>
<span class="n">metadata_time_store</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="nb">float</span>
<span class="n">metadata_values_store</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="nb">float</span>

<span class="c1"># Set the filenames</span>
<span class="n">meta_store_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;segment</span><span class="si">{</span><span class="n">segment_nr</span><span class="si">}</span><span class="s1">_meta.json&#39;</span>
<span class="n">values_store_filename</span> <span class="o">=</span> <span class="n">meta_store_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_meta.json&#39;</span><span class="p">,</span> <span class="s1">&#39;_values.bin&#39;</span><span class="p">)</span>
<span class="n">time_store_filename</span> <span class="o">=</span> <span class="n">meta_store_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_meta.json&#39;</span><span class="p">,</span> <span class="s1">&#39;_time.bin&#39;</span><span class="p">)</span>

<span class="n">metadata_values_store</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">values_store_filename</span>
<span class="n">metadata_time_store</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">time_store_filename</span>

<span class="n">write_df_data</span><span class="p">(</span><span class="n">metadata_time_store</span><span class="p">,</span> <span class="n">metadata_values_store</span><span class="p">,</span> <span class="n">path_to_data</span><span class="p">,</span> <span class="n">meta_store_filename</span><span class="p">,</span> <span class="n">df_predictions</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_predictions</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_tsdf_dataframe</span><span class="p">(</span><span class="n">path_to_data</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;segment</span><span class="si">{</span><span class="n">segment_nr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df_predictions</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>tremor_power</th>
      <th>pred_tremor_proba</th>
      <th>pred_tremor_logreg</th>
      <th>pred_arm_at_rest</th>
      <th>pred_tremor_checked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0.471588</td>
      <td>0.038968</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4.0</td>
      <td>0.327252</td>
      <td>0.035365</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.0</td>
      <td>0.114138</td>
      <td>0.031255</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12.0</td>
      <td>0.180988</td>
      <td>0.021106</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>16.0</td>
      <td>0.090009</td>
      <td>0.021078</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
</section>
</section>
<section id="step-4-quantify-tremor">
<h2>Step 4: Quantify tremor<a class="headerlink" href="#step-4-quantify-tremor" title="Link to this heading"></a></h2>
<p>The tremor power of all predicted tremor windows (where <code class="docutils literal notranslate"><span class="pre">pred_tremor_checked</span></code> is 1) is used for tremor quantification. A datetime column is also added, providing necessary information before aggregating over specified hours in Step 5.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytz</span>

<span class="n">df_quantification</span> <span class="o">=</span> <span class="n">df_predictions</span><span class="p">[[</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="p">,</span> <span class="s1">&#39;pred_arm_at_rest&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_checked&#39;</span><span class="p">,</span><span class="s1">&#39;tremor_power&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_quantification</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_predictions</span><span class="p">[</span><span class="s1">&#39;pred_tremor_checked&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;tremor_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># tremor power of non-tremor windows is set to None</span>

<span class="c1"># Create datetime column based on the start time of the segment</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">metadata_time</span><span class="o">.</span><span class="n">start_iso8601</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;CET&#39;</span><span class="p">))</span> <span class="c1"># convert to correct timezone if necessary</span>
<span class="n">df_quantification</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="si">}</span><span class="s1">_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">df_quantification</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
<span class="n">df_quantification</span> <span class="o">=</span> <span class="n">df_quantification</span><span class="p">[[</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="si">}</span><span class="s1">_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_arm_at_rest&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_checked&#39;</span><span class="p">,</span> <span class="s1">&#39;tremor_power&#39;</span><span class="p">]]</span>

<span class="n">df_quantification</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>time_dt</th>
      <th>pred_arm_at_rest</th>
      <th>pred_tremor_checked</th>
      <th>tremor_power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>2019-08-20 12:39:16+02:00</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.471588</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4.0</td>
      <td>2019-08-20 12:39:20+02:00</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.327252</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.0</td>
      <td>2019-08-20 12:39:24+02:00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12.0</td>
      <td>2019-08-20 12:39:28+02:00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>16.0</td>
      <td>2019-08-20 12:39:32+02:00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8579</th>
      <td>34316.0</td>
      <td>2019-08-20 22:11:12+02:00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8580</th>
      <td>34320.0</td>
      <td>2019-08-20 22:11:16+02:00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8581</th>
      <td>34324.0</td>
      <td>2019-08-20 22:11:20+02:00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8582</th>
      <td>34328.0</td>
      <td>2019-08-20 22:11:24+02:00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8583</th>
      <td>34332.0</td>
      <td>2019-08-20 22:11:28+02:00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>8584 rows × 5 columns</p>
</div>
<section id="run-steps-1-4-for-all-segments">
<h3>Run steps 1 - 4 for all segments <a id='multiple_segments_cell'></a><a class="headerlink" href="#run-steps-1-4-for-all-segments" title="Link to this heading"></a></h3>
<p>If your data is also stored in multiple segments, you can modify <code class="docutils literal notranslate"><span class="pre">segments</span></code> in the cell below to a list of the filenames of your respective segmented data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">files</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytz</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tsdf_dataframe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">IMUConfig</span><span class="p">,</span> <span class="n">TremorConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">preprocess_imu_data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.pipelines.tremor_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_tremor_features</span><span class="p">,</span> <span class="n">detect_tremor</span>

<span class="c1"># Set the path to where the prepared data is saved</span>
<span class="n">path_to_data</span> <span class="o">=</span>  <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../example_data&#39;</span><span class="p">)</span>
<span class="n">path_to_prepared_data</span> <span class="o">=</span> <span class="n">path_to_data</span> <span class="o">/</span> <span class="s1">&#39;imu&#39;</span>

<span class="c1"># Load the pre-trained logistic regression classifier</span>
<span class="n">tremor_detection_classifier_package_filename</span> <span class="o">=</span> <span class="s1">&#39;tremor_detection_clf_package.pkl&#39;</span>
<span class="n">full_path_to_classifier_package</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="s1">&#39;paradigma&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;assets&#39;</span> <span class="o">/</span> <span class="n">tremor_detection_classifier_package_filename</span>

<span class="c1"># Create a list of dataframes to store the quantifications of all segments</span>
<span class="n">list_df_quantifications</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">segments</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0001&#39;</span><span class="p">,</span><span class="s1">&#39;0002&#39;</span><span class="p">]</span> <span class="c1"># list with all  available segments</span>

<span class="k">for</span> <span class="n">segment_nr</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>

    <span class="c1"># Load the data</span>
    <span class="n">df_data</span><span class="p">,</span> <span class="n">metadata_time</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_tsdf_dataframe</span><span class="p">(</span><span class="n">path_to_prepared_data</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;IMU_segment&#39;</span><span class="o">+</span><span class="n">segment_nr</span><span class="p">)</span>

    <span class="c1"># 1: Preprocess the data</span>
    <span class="c1"># Change column names if necessary by creating parameter column_mapping (see previous cells for an example)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">IMUConfig</span><span class="p">()</span>
    <span class="n">df_preprocessed_data</span> <span class="o">=</span> <span class="n">preprocess_imu_data</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;gyroscope&#39;</span><span class="p">,</span> <span class="n">watch_side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="c1"># 2: Extract features</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">TremorConfig</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="s1">&#39;features&#39;</span><span class="p">)</span>
    <span class="n">df_features</span> <span class="o">=</span> <span class="n">extract_tremor_features</span><span class="p">(</span><span class="n">df_preprocessed_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="c1"># 3: Detect tremor</span>
    <span class="n">df_predictions</span> <span class="o">=</span> <span class="n">detect_tremor</span><span class="p">(</span><span class="n">df_features</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">full_path_to_classifier_package</span><span class="p">)</span>

    <span class="c1"># 4: Quantify tremor</span>
    <span class="n">df_quantification</span> <span class="o">=</span> <span class="n">df_predictions</span><span class="p">[[</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="p">,</span> <span class="s1">&#39;pred_arm_at_rest&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_checked&#39;</span><span class="p">,</span><span class="s1">&#39;tremor_power&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_quantification</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_predictions</span><span class="p">[</span><span class="s1">&#39;pred_tremor_checked&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;tremor_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create datetime column based on the start time of the segment</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">metadata_time</span><span class="o">.</span><span class="n">start_iso8601</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;CET&#39;</span><span class="p">))</span> <span class="c1"># convert to correct timezone if necessary</span>
    <span class="n">df_quantification</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="si">}</span><span class="s1">_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">df_quantification</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
    <span class="n">df_quantification</span> <span class="o">=</span> <span class="n">df_quantification</span><span class="p">[[</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">time_colname</span><span class="si">}</span><span class="s1">_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_arm_at_rest&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_tremor_checked&#39;</span><span class="p">,</span> <span class="s1">&#39;tremor_power&#39;</span><span class="p">]]</span>

    <span class="c1"># Add the quantifications of the current segment to the list</span>
    <span class="n">df_quantification</span><span class="p">[</span><span class="s1">&#39;segment_nr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment_nr</span>
    <span class="n">list_df_quantifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_quantification</span><span class="p">)</span>

<span class="n">df_quantification</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">list_df_quantifications</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="step-5-compute-aggregated-tremor-measures">
<h2>Step 5: Compute aggregated tremor measures<a class="headerlink" href="#step-5-compute-aggregated-tremor-measures" title="Link to this heading"></a></h2>
<p>The final step is to compute the amount of tremor time and tremor power with the function <a class="reference external" href="https://github.com/biomarkersParkinson/paradigma/blob/main/src/paradigma/pipelines/tremor_pipeline.py#:~:text=aggregate_tremor"><code class="docutils literal notranslate"><span class="pre">aggregate_tremor</span></code></a>, which aggregates over all windows in the input dataframe. Depending on the size of the input dateframe, you could select the hours and days (both optional) that you want to include in this analysis. In this case we use data collected between 8 am and 10 pm (specified as <code class="docutils literal notranslate"><span class="pre">select_hours_start</span></code> and <code class="docutils literal notranslate"><span class="pre">select_hours_end</span></code>), and days with at least 10 hours of data (<code class="docutils literal notranslate"><span class="pre">min_hours_per_day</span></code>) based on. Based on the selected data, we compute aggregated measures for tremor time and tremor power:</p>
<ul class="simple">
<li><p>Tremor time is calculated as the number of detected tremor windows, as percentage of the number of windows while the arm is at rest or in stable posture (when <code class="docutils literal notranslate"><span class="pre">below_tremor_power</span></code> does not exceed <code class="docutils literal notranslate"><span class="pre">config.movement_threshold</span></code>). This way the tremor time is controlled for the amount of time the arm is at rest or in stable posture, when rest tremor and re-emergent tremor could occur.</p></li>
<li><p>For tremor power the following aggregates are derived: the mode, median and 90th percentile of tremor power (specified in <code class="docutils literal notranslate"><span class="pre">config.aggregates_tremor_power</span></code>). The median and modal tremor power reflect the typical tremor severity, whereas the 90th percentile reflects the maximal tremor severity within the observed timeframe. The modal tremor power is computed as the peak in the probability density function of tremor power, which is evaluated at the points specified in <code class="docutils literal notranslate"><span class="pre">config.evaluation_points_tremor_power</span></code> (300 points between 0 and 6 log tremor power). The aggregated tremor measures and metadata are stored in a json file.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">select_hours</span><span class="p">,</span> <span class="n">select_days</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paradigma.pipelines.tremor_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">aggregate_tremor</span>

<span class="n">select_hours_start</span> <span class="o">=</span> <span class="s1">&#39;08:00&#39;</span> <span class="c1"># you can specifiy the hours and minutes here</span>
<span class="n">select_hours_end</span> <span class="o">=</span> <span class="s1">&#39;22:00&#39;</span>
<span class="n">min_hours_per_day</span> <span class="o">=</span> <span class="mi">10</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Before aggregation we select data collected between </span><span class="si">{</span><span class="n">select_hours_start</span><span class="si">}</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">and </span><span class="si">{</span><span class="n">select_hours_end</span><span class="si">}</span><span class="s1">. We also select days with at least </span><span class="si">{</span><span class="n">min_hours_per_day</span><span class="si">}</span><span class="s1"> hours of data.&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The following tremor power aggregates are derived: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">aggregates_tremor_power</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

<span class="c1"># Select the hours that should be included in the analysis</span>
<span class="n">df_quantification</span> <span class="o">=</span> <span class="n">select_hours</span><span class="p">(</span><span class="n">df_quantification</span><span class="p">,</span> <span class="n">select_hours_start</span><span class="p">,</span> <span class="n">select_hours_end</span><span class="p">)</span>

<span class="c1"># Remove days with less than the specified minimum amount of hours</span>
<span class="n">df_quantification</span> <span class="o">=</span> <span class="n">select_days</span><span class="p">(</span><span class="n">df_quantification</span><span class="p">,</span> <span class="n">min_hours_per_day</span><span class="p">)</span>

<span class="c1"># Compute the aggregated measures</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">TremorConfig</span><span class="p">()</span>
<span class="n">d_tremor_aggregates</span> <span class="o">=</span> <span class="n">aggregate_tremor</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">df_quantification</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">)</span>

<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">d_tremor_aggregates</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Before aggregation we select data collected between 08:00 and 22:00. We also select days with at least 10 hours of data.
The following tremor power aggregates are derived: [&#39;mode_binned&#39;, &#39;median&#39;, &#39;90p&#39;].
{&#39;aggregated_tremor_measures&#39;: {&#39;90p_tremor_power&#39;: 1.3259483071516063,
                                &#39;median_tremor_power&#39;: 0.5143985314908104,
                                &#39;modal_tremor_power&#39;: 0.3,
                                &#39;perc_windows_tremor&#39;: 19.386769676484793},
 &#39;metadata&#39;: {&#39;nr_valid_days&#39;: 1,
              &#39;nr_windows_rest&#39;: 8284,
              &#39;nr_windows_total&#39;: 12600}}
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="gait_analysis.html" class="btn btn-neutral float-left" title="Gait analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="pulse_rate_analysis.html" class="btn btn-neutral float-right" title="Pulse rate analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Erik Post, Kars Veldkamp, Nienke Timmermans, Diogo Coutinho Soriano, Vedran Kasalica, Peter Kok, and Luc Evers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>